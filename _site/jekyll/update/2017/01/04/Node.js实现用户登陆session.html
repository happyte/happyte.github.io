<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Node.js实现用户登陆session</title> <meta name="description" content="Node.js实现用户登陆session"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://localhost:4000/jekyll/update/2017/01/04/Node.js%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86session.html"> <link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="https://github.com/answershuto" ><i class="icon icon-github"></i> Github</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">Node.js实现用户登陆session</h1> <p class="post-meta"><time datetime="2017-01-04T20:52:00+08:00" itemprop="datePublished">Jan 4, 2017</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <h1 id="nodejs实现session">Node.js实现session</h1> <h2 id="关于session">关于session</h2> <p>由于HTTP是一种无状态协议，所以无法在请求中保存用户登陆状态。</p> <p>session是是通过服务端保存的一个表结构来对应用户登陆状态，其在客户端的呈现就是cookie。</p> <p>其原理大概是这样：用户登陆以后服务端会自动生成一个较长的不重复随机数，及session，用该session作为key，用户信息及其他信息作为value，保存在内存或者数据库中，方便查询。服务端用setCookie的方式将session通过http返回给客户端并将session保存在浏览器的cookie中。下次客户端发起其他非登陆请求时会携带此cookie，到了服务端以后通过查阅之前的session表得知用户登陆状态并在成功的情况下得到用户信息。</p> <h2 id="session的实现">session的实现</h2> <p>这里我们用到两个模块，分别是express-session以及cookie-parser。</p> <p>用中间件到方式将cookie-parser加入到express中去，用以解析cookie，即得到session。</p> <div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cookie-parser'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>
</code></pre></div> <p>再加入express-session中间件。</p> <div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express-session'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
		<span class="na">resave</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="na">rolling</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="na">saveUninitialized</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="na">secret</span><span class="p">:</span> <span class="nx">RandomSecret</span><span class="p">(),</span>
		<span class="na">name</span><span class="p">:</span> <span class="s1">'H5Session'</span><span class="p">,</span>
		<span class="na">cookie</span><span class="p">:</span> <span class="p">{</span> <span class="na">maxAge</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">}</span>
	<span class="p">}));</span>
</code></pre></div> <p>接着自己写一个中间件用以过滤请求。</p> <p>这里给出我自己项目的代码，</p> <p>成功登陆以后，给req.session.user赋值。</p> <p>在登陆以及注册请求是不需要校验的，直接next，有session的也next，走向下一个中间件，这段代码需要放在route代码之前。非登陆及注册请求的没有session的请求直接返回用户权限异常提示。</p> <div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'userName'</span><span class="p">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">userName</span><span class="p">};</span>
</code></pre></div> <div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="s1">'/H5/Login'</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="s1">'/H5/Register'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">next</span><span class="p">();</span><span class="cm">/*请求为登陆或者注册则不需要校验session*/</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="na">result</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">content</span><span class="p">:</span> <span class="s1">'用户权限异常'</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">})</span>
</code></pre></div> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/answershuto" target="_blank"><i class="icon icon-github"></i></a></li> </ul> <p> <br><small>&copy;2017 CaoYang , All rights reserved.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html><!-- by nandomoreira.me -->